---
// src/components/widget/DirectoryTree.astro

import { getCollection } from "astro:content";
import { url } from "../../utils/url-utils";
import WidgetLayout from "./WidgetLayout.astro";

// --- El c贸digo de la parte superior (construcci贸n del 谩rbol) no cambia ---
const allPosts = await getCollection(
	"posts",
	({ data }) => data.draft !== true,
);

const directoryTree: Record<string, any> = {};

allPosts.forEach((post) => {
	const pathParts = post.id.split("/");
	let currentLevel = directoryTree;

	for (let i = 0; i < pathParts.length - 1; i++) {
		const part = pathParts[i];
		if (!currentLevel[part]) {
			currentLevel[part] = {};
		}
		currentLevel = currentLevel[part];
	}

	const fileName = pathParts[pathParts.length - 1];
	currentLevel[fileName] = {
		slug: post.slug,
		title: post.data.title,
	};
});

function renderTree(tree: Record<string, any>) {
	const keys = Object.keys(tree);
	if (keys.length === 0) return "";

	let html = '<ul class="sub-list hidden">';
	for (const key of keys) {
		const node = tree[key];
		if (node.slug) {
			html += `<li class="file"><a href="${url(`/posts/${node.slug}/`)}">${node.title}</a></li>`;
		} else {
			const hasChildren = Object.keys(node).length > 0;
			html += `<li class="folder"><span class="folder-toggle">${key}</span>`;
			if (hasChildren) {
				html += renderTree(node);
			}
			html += "</li>";
		}
	}
	html += "</ul>";
	return html;
}

const treeHtml = renderTree(directoryTree);
---

<WidgetLayout name="Navegaci贸n por Carpetas" id="directory-tree">
    <Fragment set:html={treeHtml.replace('class="sub-list hidden"', 'class="sub-list"')}/>
</WidgetLayout>

<script>
    // 1. Envolvemos toda nuestra l贸gica en una funci贸n reutilizable.
    function initializeTreeInteraction() {
        const folderToggles = document.querySelectorAll('#directory-tree .folder-toggle');
        
        folderToggles.forEach(toggle => {
            // Prevenimos a帽adir el mismo evento m煤ltiples veces
            if (toggle.dataset.initialized) return;
            toggle.dataset.initialized = 'true';

            toggle.addEventListener('click', () => {
                const subList = toggle.nextElementSibling;
                if (subList && subList.tagName === 'UL') {
                    subList.classList.toggle('hidden');
                    if (toggle.parentElement) {
                        toggle.parentElement.classList.toggle('expanded');
                    }
                }
            });
        });
    }

    // 2. Ejecutamos la funci贸n en la carga inicial de la p谩gina.
    document.addEventListener('astro:page-load', initializeTreeInteraction);
    
    // 3. Le pedimos a Astro que tambi茅n ejecute nuestra funci贸n DESPUS de cada transici贸n de p谩gina.
    document.addEventListener('astro:after-swap', initializeTreeInteraction);
</script>

<style is:global>
    #directory-tree ul {
        list-style: none;
        padding-left: 1rem;
        margin-top: 0.25rem;
    }
    #directory-tree .sub-list.hidden {
        display: none;
    }
    #directory-tree li {
        margin-bottom: 0.25rem;
    }
    #directory-tree .folder-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        user-select: none;
        font-weight: 500;
        color: var(--btn-content);
        transition: color 0.2s, filter 0.2s;
    }
    #directory-tree .folder-toggle:hover {
        color: var(--primary);
        filter: brightness(1.2);
    }
    #directory-tree .folder > .folder-toggle::before {
        content: '';
        margin-right: 0.5rem;
    }
    #directory-tree .folder.expanded > .folder-toggle::before {
        content: '';
    }
    #directory-tree .file a {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: var(--btn-content);
        font-size: 0.9em;
        transition: color 0.2s;
    }
    #directory-tree .file a:hover {
        color: var(--primary);
    }
    #directory-tree .file a::before {
        content: '';
        margin-right: 0.5rem;
        opacity: 0.8;
    }
</style>